---
title: "Ejercicio 7"
output:
  html_document:
    df_print: paged
---

## David Montero Loaiza

### Problema 1

Escribe una función que tenga como input un vector x con valores distribuidos uniformemente, y unos parámetros a, b, m y n; y que devuelva como output una matriz cuya primera columna sea y = a + b x más un término estocástico sacado de una gaussiana con sigma = c + d x^2; y la segunda columna el error sigma = m + n x^2. 

```{r}
generate_y_sigmas = function(x,a,b,m,n){
  
  # SIGMA
  sigma = m + n * x^2
  
  # GAUSSIANA
  y = a + b * x + rnorm(x,0,sigma)
  
  # DATA FRAME
  df = data.frame("y" = y,"sigma" = sigma)
  
  # RETORNAR DATA FRAME
  return(df)
  
}
```

### Problema 2

Escribe otra función que haga lo mismo que la anterior pero con un parámetro más “c” de tal forma que haga lo mismo pero con un modelo y = a + b x + c x^2.

```{r}
generate_y_sigmas_v2 = function(x,a,b,c,m,n){
  
  # SIGMA
  sigma = m + n * x^2
  
  # GAUSSIANA
  y = a + b * x + c * x^2 + rnorm(x,0,sigma)
  
  # DATA FRAME
  df = data.frame("y" = y,"sigma" = sigma)
  
  # RETORNAR DATA FRAME
  return(df)
  
}
```

### Problema 3

Usando como valores a = 1, b = 2, m = 0.1 y n = 0.04 para el modelo de la primera función: calcula los parámetros para las que el likelihood es máximo asumiendo un modelo con dos parámetros y = a + b x. Calcula el valor del chi2 y calcula el nivel de confianza con el que rechazaríamos este ajuste. 

```{r}
generate_X = function(x,gpoly){
  
  # LA MATRIZ SE INICIA CON 1S
  X = rep(1,length(x))
  
  # SE AGREGAN LOS VALORES DE X ELEVADOS A CADA GRADO
  for(i in 1:gpoly){
    
    # SE ADJUNTAN LOS VALORES A LA MATRIZ
    X = cbind(X,x^i)
    
  }
  
  # SE RETORNA LA MATRIZ
  return(X)
  
}

maxLike = function(x,y,sigma,gpoly){
  
  # CREAR MATRIZ X
  X = generate_X(x,gpoly)
  
  # COVARIANZA Y
  covY = diag(sigma^2)
  
  # MINIMIZAR ML
  param = solve(t(X) %*% solve(covY) %*% X) %*% (t(X) %*% solve(covY)) %*% y
  
  # RETORNAR PARAMETROS
  return(param)
  
}

chiSquared = function(x,theta,y,sigma,gpoly){
  
  # CREAR MATRIZ X
  X = generate_X(x,gpoly)
  
  # CALCULAR Z
  Z = (y - X %*% theta) / sigma
  
  # RETORNAR CHI2
  return(sum(Z^2))
  
}
```

```{r}
# TAMANO DE X
N = 100

# VECTOR X
x = runif(N,0,10)

# PARAMETROS
a = 1
b = 2
m = 0.1
n = 0.04

# GRADO DEL POLINOMIO
g = 1

# NUMERO DE PARAMETROS
M = g + 1

# VECTOR Y Y SIGMA
df = generate_y_sigmas(x,a,b,m,n)
y = df$y
sig = df$sigma

# PARAMETROS
theta = maxLike(x,y,sig,gpoly = g)

# GRAFICA X Y
plot(x,y,ylim = c(min(y - sig),max(y + sig)))
abline(theta[1],theta[2],col = "red") # RECTA DE AJUSTE
arrows(x,y - sig,x,y + sig,length = 0.05,angle = 90,code = 3) # ERRORES

# CHI2
chi2 = chiSquared(x,theta,y,sig,g)

# CONFIDENCE LEVEL
cl = pchisq(chi2,N - M) * 100

# RESPUESTA
sprintf("Chi2 = %f, Rechazamos H0 con un %f%% de confianza",chi2,cl)
```

### Problema 4

Repite el paso anterior con el mismo modelo pero usando la segunda función. c = 0.01.

```{r}
# TAMANO DE X
N = 100

# VECTOR X
x = runif(N,0,10)

# PARAMETROS
a = 1
b = 2
c = 0.01
m = 0.1
n = 0.04

# GRADO DEL POLINOMIO
g = 1

# NUMERO DE PARAMETROS
M = g + 1

# VECTOR Y Y SIGMA
df = generate_y_sigmas_v2(x,a,b,c,m,n)
y = df$y
sig = df$sigma

# PARAMETROS
theta = maxLike(x,y,sig,gpoly = g)

# GRAFICA X Y
plot(x,y,ylim = c(min(y - sig),max(y + sig)))
abline(theta[1],theta[2],col = "red") # RECTA DE AJUSTE
arrows(x,y - sig,x,y + sig,length = 0.05,angle = 90,code = 3) # ERRORES

# CHI2
chi2 = chiSquared(x,theta,y,sig,g)

# CONFIDENCE LEVEL
cl = pchisq(chi2,N - M) * 100

# RESPUESTA
sprintf("Chi2 = %f, Rechazamos H0 con un %f%% de confianza",chi2,cl)
```

### Problema 5

Usando la primera de las funciones anteriores con los valores dados en 3) calcula el valor del likelihood ratio “q” para un modelo con 2 y 3 parámetros. ¿Con qué confidence level podemos aceptar H0? Comenta el resultado: ¿qué modelo es mejor el primero o el segundo?.

```{r}
# TAMANO DE X
N = 100

# VECTOR X
x = runif(N,0,10)

# PARAMETROS
a = 1
b = 2
c = 0.01
m = 0.1
n = 0.04

# GRADO DEL POLINOMIO
g = 1

# NUMERO DE PARAMETROS
M = g + 1

# VECTOR Y Y SIGMA
df = generate_y_sigmas_v2(x,a,b,c,m,n)
y = df$y
sig = df$sigma

# CHI2 PARA POLINOMIO GRADO 1
chi2poly1 = chiSquared(x,maxLike(x,y,sig,gpoly = 1),y,sig,gpoly = 1)

# CHI2 PARA POLINOMIO GRADO 2
chi2poly2 = chiSquared(x,maxLike(x,y,sig,gpoly = 2),y,sig,gpoly = 2)

# q
q = 2 * log(chi2poly1/chi2poly2)

# CL
cl = (1 - pchisq(q,1)) * 100

# RESPUESTA
sprintf("Chi2 = %f, Aceptamos H0 con un %f%% de confianza",chi2,cl)
```
