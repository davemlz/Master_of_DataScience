---
title: "Practica de Remuestreo"
output:
  html_document:
    df_print: paged
---

## Daniel García Diaz (garciad@ifca.unican.es)

## Estudiante: David Montero Loaiza

Las tecnicas de remuestreo son tecnicas desarrolladas hace pocos años para calcular valores estadisticos, basandose en tecnicas computacionales intensivas que evitan los calculos complejos de la teoria estadistica tradicional.

Serie temporal de datos fisico-quimicos medidos en el embalse de Cuerda del Pozo (Soria) en los años 2014 y 2015.

File -> CdP_practica_estadistica.csv

```{r}
# LEER DATOS
df = read.csv(url("https://raw.githubusercontent.com/davemlz/Master_of_DataScience/master/Estadistica/Pr%C3%A1ctica%20Remuestreo-20191218/CdP_practica_estadistica.csv"))
```

Carga el dataset con R y selecciona la temperatura de ambos años por separado. Selecciona solo los datos de Temperatura para el Verano (Julio, Agosto y Septiembre).

NOTA!! -> Formatea la fecha para poder dividir los datos en años.

```{r}
# FORMATEAR FECHA
df$date = as.Date(df$date,format = "%d/%m/%Y")

# ELIMINAR NAS
df = na.omit(df)

# MESES DE VERANO
verano = c("07","08","09")

# SELECCIONAR MESES DE VERANO Y COLUMNAS DE FECHA Y TEMPERATURA
df = df[format(df$date,"%m") %in% verano,1:2]

# CREAR UNA NUEVA COLUMNA PARA YEAR
df$year = as.factor(format(df$date,"%Y"))

# CAMBIAR EL NOMBRE DE LA COLUMNA DE TEMPERATURA
names(df)[2] = "t"
```

Calula la media, mediana y desviacion media de cada uno de los años por separado, devuelve una tabla con los datos.

```{r}
# MANEJO DE DATOS TIDY
require(dplyr)
```

```{r}
# MEDIA, MEDIANA Y DESVIACION ESTANDAR DE LA TEMPERATURA PARA CADA ANO
sumdf = df %>% group_by(year) %>% summarise(mean = mean(t),median = median(t),sd = sd(t))
sumdf
```

La siguiente función se encarga de calcular la desviación estándar dependiendo del método usado `bootstrap` o `jacknife`, recibe como parámetros `x` (muestra original), `resampled` (remuestreo por cualquiera de los dos métodos), `method` (`bootstrap` o `jacknife`).

```{r}
sdFunction = function(x,resampled,method = "bootstrap"){
  
  # TAMANO DE LA MUESTRA
  N = length(x)

  # MEDIA DE LA MUESTRA
  theta = mean(x)
  
  # TAMANO DEL REMUESTREO
  M = length(resampled)
  
  # PARTE 1 DE LA FORMULA
  part1 = 1/(M - 1)
  
  # SI EL METODO ES JACKNIFE
  if(method == "jacknife"){
    
    # MULTIPLICAR POR EL RAMANO DEL REMUESTREO
    part1 = M * part1
    
  }
  
  # PARTE 2 DE LA FORMULA
  part2 = sum((resampled - theta)^2)
  
  # PARTE 3 DE LA FORMULA
  part3 = sqrt(N)
  
  # FORMULA
  sdF = part3 * sqrt(part1 * part2)
  
  # RETORNAR DESVIACION ESTANDAR
  return(sdF)
  
}
```

### Bootstrap

Tecnica de remuestreo que consiste en generar nuevas pseudomuestras sustituyendo cada uno de los elementos de la muestra original por cualquier otro elemento elegido. Cada una de las nuevas psuedomuestras tiene el mismo número de elementos que la original. No todos los elementos de la muestra original tienen por qué aparecer en una pseudomuestra. Algunos elementos de la muestra orginal pueden aparecer repetidos en una pseudomuestra.

Crea una función que reciba un vector de números ‘x’ (la muestra original) y un número natural N, que genere una matriz que tenga N columnas siendo cada una de estas, una de las muestras de Bootstrap.

```{r}
bootstrap = function(x){
  
  # TAMANO DE X
  N = length(x)
  
  # MUESTRA BOOTSRAP
  b = sample(x,N,replace = TRUE)
  
  # RETORNAR BOOTSTRAP
  return(b)
  
}
```

```{r}
bootstrapMatrix = function(x,N){
  
  # MATRIZ VACIA
  BM = NULL
  
  for(i in 1:N){
    
    # RELLENAR MATRIZ CON MUESTRAS BOOTSTRAP
    BM = cbind(BM,bootstrap(x))
    
  }
  
  # RETORNAR MATRIZ DE BOOTSTRAP
  return(BM)
  
}
```

Calcular (para N=1000):

■ La media y la desviación estándar de la media y compararlas con la obtenida anteriormente.

```{r}
# VARIABLES PARA GUARDAR DATOS
meanBootstrap = NULL
sdBootstrap = NULL

for(i in 2014:2015){
  
  # TEMPERATURA DEL ANO EN VERANO
  x = df[df$year == i,'t']
  
  # BOOTSTRAP MATRIX
  BM = bootstrapMatrix(x,1000)
  
  # MEDIAS DE LAS PSEUDOMUESTRAS BOOTSTRAP
  thetaB = apply(BM,2,mean)
  
  # MEDIA CON BOOTSTRAP
  meanBootstrap = c(meanBootstrap,mean(thetaB))
  
  # DESVIACION ESTANDAR CON BOOTSRAP
  sdBootstrap = c(sdBootstrap,sdFunction(x,thetaB))
  
}
```

### Jacknife

Tecnica de remuestreo que consiste en generar pseudomuestras de modo que cada vez se quita un elemento de la muestra original. Las muestras por tanto tendras tamaño de N-1.

Crea una función que reciba un vector de números 'x' (la muestra original) y genere una matriz que contenga todas las muestras posibles de jacknife de la muestra original.

```{r}
jacknife = function(x){
  
  # TAMANO DE X
  N = length(x)
  
  # MATRIZ REPETIDA
  JM = matrix(rep(x,N),N,N,byrow = FALSE)
  
  # CONVERTIR LA DIAGONAL EN NA
  diag(JM) = NA
  
  # RETORNAR MATRIZ DE JACKNIFE
  return(JM)
  
}
```

La función anterior genera un remuestreo con jacknife creando una matriz en donde cada columna equivale a la muestra original, por lo tanto es una matriz de N x N, pero en donde su diagonal ha sido reemplazada por `NA`, sin embargo. En este caso, al realizar la media se utiliza en la función `mean` el argumento `na.rm` igualado a `TRUE` para omitir los valores `NA`.

Calcula:

■ La media y la desviación estándar de la media y compararlas con la obtenida anteriormente.

```{r}
# VARIABLES PARA GUARDAR DATOS
meanJacknife = NULL
sdJacknife = NULL

for(i in 2014:2015){
  
  # TEMPERATURA DEL ANO EN VERANO
  x = df[df$year == i,'t']
  
  # JACKNIFE MATRIX
  JM = jacknife(x)
  
  # MEDIAS DE LAS PSEUDOMUESTRAS JACKNIFE
  thetaJ = apply(JM,2,mean,na.rm = TRUE)
  
  # MEDIA CON JACKNIFE
  meanJacknife = c(meanJacknife,mean(thetaJ))
  
  # DESVIACION ESTANDAR CON JACKNIFE
  sdJacknife = c(sdJacknife,sdFunction(x,thetaJ,method = "jacknife"))
  
}
```

```{r}
# COMPARACION FINAL
compdf = cbind(sumdf,meanBootstrap,sdBootstrap,meanJacknife,sdJacknife)
compdf
```

```{r}
# DIFERENCIAS ENTRE LOS VALORES DE LA MUESTRA ORIGINAL Y LOS METODOS USADOS
difdf = data.frame(year = c(2014,2015),
                   meanDifBootstrap = compdf$meanBootstrap - compdf$mean,
                   meanDifJacknife = compdf$meanJacknife - compdf$mean,
                   sdDifBootstrap = compdf$sdBootstrap - compdf$sd,
                   sdDifJacknife = compdf$sdJacknife - compdf$sd)

difdf
```

La diferencia entre la media de la muestra original y la media obtenida con las técnicas bootstrap y jacknife tiende a ser cero para cada año. En el caso de Jacknife, la diferencia es cero ya que, en la práctica, se están tomando los mismos valores para cada pseudomuestra, evitando un elemento diferente en cada caso, mientras que en el método de bootstrap la diferencia no es cero pero tiende a serlo, ya que se toman valores de la muestra original, con repeticiones, para rellenar cada pseudomuestra de bootstrap.

En el caso de las desviaciones estándar, la obtenida por la técnica bootstrap se aproxima mucho más a la desviación estándar de la muestra original que la obtenida por la técnica jacknife para cada uno de los años.